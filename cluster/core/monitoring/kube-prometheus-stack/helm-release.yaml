---
apiVersion: helm.toolkit.fluxcd.io/v2beta1
kind: HelmRelease
metadata:
  name: kube-prometheus-stack
  namespace: monitoring
spec:
  chart:
    spec:
      chart: kube-prometheus-stack
      interval: 5m
      sourceRef:
        kind: HelmRepository
        name: prometheus-community-charts
        namespace: flux-system
      version: 35.0.3
  dependsOn:
    - name: longhorn
      namespace: longhorn-system
  install:
    remediation:
      retries: 3
  interval: 5m
  upgrade:
    force: true
    remediation:
      retries: 3
  values:
    alertmanager:
      alertmanagerSpec:
        storage:
          volumeClaimTemplate:
            spec:
              accessModes:
                - ReadWriteOnce
              resources:
                requests:
                  storage: 1Gi
              storageClassName: longhorn
      config:
        global:
          resolve_timeout: 5m
          slack_api_url: ${SECRET_ALERT_MANAGER_DISCORD_WEBHOOK}
        inhibit_rules:
          - equal:
              - alertname
              - namespace
            source_match:
              severity: critical
            target_match:
              severity: warning
        receivers:
          - name: "null"
          - name: "opsgenie"
            opsgenie_configs:
              - api_key: ${SECRET_OPSGENIE_API_KEY}
                send_resolved: true
                priority: '{{ if eq .GroupLabels.severity "critical" }}P1{{ else if eq .GroupLabels.severity "warning" }}P2{{ else if eq .GroupLabels.severity "info" }}P3{{ else }}P4{{ end }}'
                message: |-
                  [{{ .Status | toUpper -}}
                  {{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{- end -}}
                  ] {{ .CommonLabels.alertname }}
                description: |-
                  {{ if gt (len .Alerts.Firing) 0 -}}
                  Alerts Firing:
                  {{ range .Alerts.Firing }}
                  - Message: {{ .Annotations.message }}
                    Labels:
                  {{ range .Labels.SortedPairs }}   - {{ .Name }} = {{ .Value }}
                  {{ end }}   Annotations:
                  {{ range .Annotations.SortedPairs }}   - {{ .Name }} = {{ .Value }}
                  {{ end }}   Source: {{ .GeneratorURL }}
                  {{ end }}
                  {{- end }}
                  {{ if gt (len .Alerts.Resolved) 0 -}}
                  Alerts Resolved:
                  {{ range .Alerts.Resolved }}
                  - Message: {{ .Annotations.message }}
                    Labels:
                  {{ range .Labels.SortedPairs }}   - {{ .Name }} = {{ .Value }}
                  {{ end }}   Annotations:
                  {{ range .Annotations.SortedPairs }}   - {{ .Name }} = {{ .Value }}
                  {{ end }}   Source: {{ .GeneratorURL }}
                  {{ end }}
                  {{- end }}
                  View Alert in Karma:
                    https://karma.${SECRET_DOMAIN}/?q=%40receiver%3D{{ .Receiver | urlquery }}&q=%40state%3Dactive
                details:
                  namespace: "{{- if .CommonLabels.exported_namespace -}}{{- .CommonLabels.exported_namespace -}}{{- else if .CommonLabels.namespace -}}{{- .CommonLabels.namespace -}}{{- end -}}"
                  pod: "{{- if .CommonLabels.pod -}}{{- .CommonLabels.pod -}}{{- end -}}"
                  deployment: "{{- if .CommonLabels.deployment -}}{{- .CommonLabels.deployment -}}{{- end -}}"
                  alertname: "{{ .GroupLabels.alertname }}"
                  severity: "{{ .GroupLabels.severity }}"
                tags: "{{ .GroupLabels.severity }},
                  {{ .GroupLabels.alertname }},
                  {{ .GroupLabels.namespace }},
                  {{- if .CommonLabels.exported_namespace -}}{{ .CommonLabels.exported_namespace }},{{- end -}}"
                responders:
                  - id: ab411aaa-0f56-477a-9028-13cd801e5213
                    type: team
          - name: discord
            slack_configs:
              - channel: "#k8s-uk-home-notifications"
                icon_url: https://avatars3.githubusercontent.com/u/3380462?s=200&v=4
                send_resolved: true
                text: |-
                  {{ range .Alerts -}}
                    **Alert:** {{ .Annotations.title }}{{ if .Labels.severity }} - `{{ .Labels.severity }}`{{ end }}

                  **Description:** {{ if ne .Annotations.description ""}}{{ .Annotations.description }}{{else}}N/A{{ end }}
                  **Details:**
                    {{ range .Labels.SortedPairs }} â€¢ *{{ .Name }}:* `{{ .Value }}`
                    {{ end }}
                  {{ end }}
                title: '[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ if ne .CommonAnnotations.summary ""}}{{ .CommonAnnotations.summary }}{{ else }}{{ .CommonLabels.alertname }}{{ end }}'
                username: Prometheus
        route:
          group_by:
            - alertname
            - namespace
            - severity
          group_interval: 5m
          group_wait: 30s
          receiver: opsgenie
          repeat_interval: 6h
          routes:
            - match:
                alertname: Watchdog
              receiver: "null"
            - continue: true
              receiver: opsgenie
      ingress:
        enabled: false
    fullnameOverride: prometheus
    grafana:
      enabled: false
      forceDeployDashboards: true
      sidecar:
        dashboards:
          multicluster:
            etcd:
              enabled: true
    kube-state-metrics:
      fullnameOverride: kube-state-metrics
    kubeApiServer:
      enabled: true
    kubeControllerManager:
      enabled: false
      endpoints:
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_1}
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_2}
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_3}
      service:
        port: 10250
        targetPort: 10250
    kubeEtcd:
      enabled: true
      endpoints:
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_1}
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_2}
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_3}
    kubeProxy:
      enabled: true
      endpoints:
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_1}
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_2}
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_3}
      service:
        port: 10249
        targetPort: 10249
    kubeScheduler:
      enabled: true
      endpoints:
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_1}
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_2}
        - ${SECRET_K3S_CONTROL_PLANE_ADDRESS_3}
      service:
        port: 10250
        targetPort: 10250
    kubelet:
      enabled: true
      serviceMonitor:
        metricRelabelings:
          - action: replace
            sourceLabels:
              - node
            targetLabel: instance
    nameOverride: ""
    prometheus:
      ingress:
        enabled: false
      prometheusSpec:
        additionalScrapeConfigs:
          - honor_timestamps: true
            job_name: minio
            metrics_path: /minio/v2/metrics/cluster
            static_configs:
              - targets:
                  - minio.tools:9000
          - job_name: felix_metrics
            kubernetes_sd_configs:
              - role: endpoints
            relabel_configs:
              - action: keep
                regex: felix-metrics-svc
                replacement: $1
                source_labels:
                  - __meta_kubernetes_service_name
            scheme: http
            scrape_interval: 5s
          - job_name: kube_controllers_metrics
            kubernetes_sd_configs:
              - role: endpoints
            relabel_configs:
              - action: keep
                regex: kube-controllers-metrics-svc
                replacement: $1
                source_labels:
                  - __meta_kubernetes_service_name
            scheme: http
            scrape_interval: 5s
        enableAdminAPI: true
        podAntiAffinity: hard
        retentionSize: "6GB"
        nodeSelector:
          kubernetes.io/arch: amd64
          node_locality: internal
        podMonitorNamespaceSelector: {}
        podMonitorSelector: {}
        podMonitorSelectorNilUsesHelmValues: false
        probeSelectorNilUsesHelmValues: false
        replicaExternalLabelName: replica
        replicas: 2
        retention: 6h
        ruleSelectorNilUsesHelmValues: false
        serviceMonitorSelectorNilUsesHelmValues: false
        storageSpec:
          volumeClaimTemplate:
            spec:
              resources:
                requests:
                  storage: 50Gi
              storageClassName: longhorn
        thanos:
          objectStorageConfig:
            key: objstore.yml
            name: thanos-objstore
        walCompression: true
      thanosService:
        enabled: true
      thanosServiceMonitor:
        enabled: true
    prometheus-node-exporter:
      fullnameOverride: node-exporter
      monitor:
        enabled: true
        relabelings:
          - action: replace
            regex: (.*)
            replacement: $1
            sourceLabels:
              - __meta_kubernetes_pod_node_name
            targetLabel: kubernetes_node
    prometheusOperator:
      admissionWebhooks:
        certManager:
          enabled: true
      configReloaderCpu: 0
      prometheusConfigReloaderImage:
        resources:
          limits:
            memory: 100Mi
          requests:
            cpu: 100m
            memory: 50Mi
